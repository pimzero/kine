#include <err.h>

#include "kine.h"

SDL_Renderer* init_window(void) {
	SDL_Init(SDL_INIT_VIDEO);

	SDL_Window* window = SDL_CreateWindow("kine", SDL_WINDOWPOS_UNDEFINED,
					      SDL_WINDOWPOS_UNDEFINED, 640, 400,
					      SDL_WINDOW_OPENGL);
	if (!window)
		errx(1, "SDL_CreateWindow: %s", SDL_GetError());

	SDL_Renderer* renderer = SDL_CreateRenderer(window, -1, 0);
	if (!renderer)
		errx(1, "SDL_CreateRenderer: %s", SDL_GetError());

	return renderer;
}

static unsigned char keymap[] = {
	[0x04] = 0x1E,
	[0x05] = 0x30,
	[0x06] = 0x2E,
	[0x07] = 0x20,
	[0x08] = 0x12,
	[0x09] = 0x21,
	[0x0A] = 0x22,
	[0x0B] = 0x23,
	[0x0C] = 0x17,
	[0x0D] = 0x24,
	[0x0E] = 0x25,
	[0x0F] = 0x26,
	[0x10] = 0x32,
	[0x11] = 0x31,
	[0x12] = 0x18,
	[0x13] = 0x19,
	[0x14] = 0x10,
	[0x15] = 0x13,
	[0x16] = 0x1F,
	[0x17] = 0x14,
	[0x18] = 0x16,
	[0x19] = 0x2F,
	[0x1A] = 0x11,
	[0x1B] = 0x2D,
	[0x1C] = 0x15,
	[0x1D] = 0x2C,
	[0x1E] = 0x02,
	[0x1F] = 0x03,
	[0x20] = 0x04,
	[0x21] = 0x05,
	[0x22] = 0x06,
	[0x23] = 0x07,
	[0x24] = 0x08,
	[0x25] = 0x09,
	[0x26] = 0x0A,
	[0x27] = 0x0B,
	[0x28] = 0x1C,
	[0x29] = 0x01,
	[0x2A] = 0x0E,
	[0x2B] = 0x0F,
	[0x2C] = 0x39,
	[0x2D] = 0x0C,
	[0x2E] = 0x0D,
	[0x2F] = 0x1A,
	[0x30] = 0x1B,
	[0x31] = 0x2B,
	[0x32] = 0x2B,
	[0x33] = 0x27,
	[0x34] = 0x28,
	[0x35] = 0x29,
	[0x36] = 0x33,
	[0x37] = 0x34,
	[0x38] = 0x35,
	[0x39] = 0x3A,
	[0x3A] = 0x3B,
	[0x3B] = 0x3C,
	[0x3C] = 0x3D,
	[0x3D] = 0x3E,
	[0x3E] = 0x3F,
	[0x3F] = 0x40,
	[0x40] = 0x41,
	[0x41] = 0x42,
	[0x42] = 0x43,
	[0x43] = 0x44,
	[0x44] = 0x57,
	[0x45] = 0x58,
	[0x47] = 0x46,
	[0x48] = 0xC5,
	[0x49] = 0x52,
	[0x4A] = 0x47,
	[0x4B] = 0x49,
	[0x4C] = 0x53,
	[0x4D] = 0x4F,
	[0x4E] = 0x51,
	[0x4F] = 0x4D,
	[0x50] = 0x4B,
	[0x51] = 0x50,
	[0x52] = 0x48,
	[0x53] = 0x45,
	[0x55] = 0x37,
	[0x56] = 0x4A,
	[0x57] = 0x4E,
	[0x59] = 0x4F,
	[0x5A] = 0x50,
	[0x5B] = 0x51,
	[0x5C] = 0x4B,
	[0x5D] = 0x4C,
	[0x5E] = 0x4D,
	[0x5F] = 0x47,
	[0x60] = 0x48,
	[0x61] = 0x49,
	[0x62] = 0x52,
	[0x63] = 0x53,
	[0x64] = 0x56,
	[0x67] = 0x59,
	[0xE0] = 0x1D,
	[0xE1] = 0x2A,
	[0xE2] = 0x38,
	[0xE3] = 0x5B,
	[0xE4] = 0x1D,
	[0xE5] = 0x36,
	[0xE6] = 0x38,
	[0xE7] = 0x5C,
};

static int32_t scancode(SDL_Scancode orig) {
	int32_t out = -1;
	if (orig <= ARRSZE(keymap) && keymap[orig])
		out = keymap[orig];

	return out;
}

void update_inputs() {
	SDL_Event event;

	lock();
	while (SDL_PollEvent(&event)) {
		switch (event.type) {
		case SDL_QUIT:
			k_state.quit = 1;
			break;
		case SDL_KEYDOWN:
			k_state.key = scancode(event.key.keysym.scancode);
			ring_push(&k_state.pressed, k_state.key);
			break;
		case SDL_KEYUP:
			if (k_state.key == scancode(event.key.keysym.scancode))
				k_state.key = -1;
			ring_push(&k_state.released,
				  scancode(event.key.keysym.scancode));
			break;
		default:
			break;
		}
	}
	unlock();
}

void update_renderer(SDL_Renderer* renderer) {
	lock();

	SDL_Surface* surface =
		SDL_CreateRGBSurfaceFrom(&k_state.framebuffer, 320, 200, 8, 320,
					 0, 0, 0, 0);

	if (!surface)
		errx(1, "SDL_CreateRGBSurfaceFrom: %s", SDL_GetError());

	if (SDL_SetPaletteColors(k_state.sdl_palette, k_state.palette, 0, 256))
		errx(1, "SDL_SetPaletteColors: %s", SDL_GetError());

	unlock();

	if (SDL_SetSurfacePalette(surface, k_state.sdl_palette))
		errx(1, "SDL_SetSurfacePalette: %s", SDL_GetError());

	SDL_Texture* texture =
		SDL_CreateTextureFromSurface(renderer, surface);
	if (!texture)
		errx(1, "SDL_CreateTextureFromSurface: %s", SDL_GetError());
	SDL_FreeSurface(surface);

	SDL_SetRenderDrawColor(renderer, 0, 0, 0, 0);
	SDL_RenderClear(renderer);
	SDL_RenderCopy(renderer, texture, 0, 0);
	SDL_RenderPresent(renderer);

	SDL_DestroyTexture(texture);
}

